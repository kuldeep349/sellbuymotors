<%- include ../sitelayouts/header.ejs %>
<style>
    .col-md-4{
        float: left;
    }
</style>
<section>
    <div class="background-image-maker gradient gradient-lr"></div>
    <div class="holder-image">
        <img src="dist/images/bg2.jpg" alt="" class="img-fluid d-none" />
    </div>
    <div class="black-overlay overlay-full"></div>
    <div class="container">
        <div class="row">
            <div class="col-12 col-sm-12 justify-content-center text-center">
                <h1 class="text-white c-font-weight-700">List Cars Listing</h1>
            </div>
        </div>
    </div>
</section>
<!-- End Page Inner-->

<!-- Breadcrumb -->
<section class="py-0 h-0">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-10 col-sm-5 col-lg-3 text-center">
                <ol class="breadcrumb justify-content-center mb-0 c-bg-primary text-white py-3 position-relative">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Car Listing</li>
                </ol>
            </div>
        </div>
    </div>
</section>
<!-- End Breadcrumb -->

<!-- List Without Sidebar -->
<section>
    <div class="row">
        <div class="col-md-3">
            <div class="row">
                <div class="col-12 col-sm-12">
                    <div class="card c-brd-light car-box mb-5">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 col-sm-6 col-md-4 col-xl-12">
                                    <label class="c-dark">Radius</label>
                                    <div class="form-group">
                                        <select class="form-control rounded" id="radius">

                                        </select>
                                    </div>
                                </div>  
                                <div class="col-12 col-sm-6 col-md-4 col-xl-12">
                                    <label class="c-dark">Make</label>
                                    <div class="form-group">
                                        <select class="form-control" id="make">

                                        </select>
                                    </div>
                                </div> 
                                <div class="col-12 col-sm-6 col-md-4 col-xl-12">
                                    <label class="c-dark">Model</label>
                                    <div class="form-group">
                                        <select class="form-control" id="model">
                                        </select>
                                    </div>
                                </div> 
                                <div class="col-12 col-sm-6 col-md-4 col-xl-12">
                                    <label class="c-dark">Model Variant</label>
                                    <div class="form-group">
                                        <select class="form-control rounded" id="aggregatedTrim">
                                        </select>
                                    </div>
                                </div> 
                                <div class="col-12 col-md-4 col-xl-12">
                                    <label class="mb-4"></label>
                                    <div class="form-group mb-0">
                                        <a href="#" class="btn btn-primary btn-md btn-block text-uppercase">Search</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="container">
                <div class="col-12 col-lg-12">
                    <div class="row mb-4">
                        <div class="col-12 col-md-5 col-xl-6 align-self-center">
                            <p class="mb-0" id="foundCar">8 Vehicles Matching</p>
                        </div>
                        <div class="col-12 col-md-5 col-xl-6 align-self-center" id="loading" style="display:none;">
                            <img src="http://mulher.m.u.pic.centerblog.net/0f2883e6.gif" width="100px" height="100px"/>
                        </div>
                    </div>
                    <div class="card car-listing-full mb-4" id="ProductShow">
                        <!--                        <div class="row">
                                                    <div class="col-12 col-lg-4 h-283">
                                                        <div class="position-relative">
                                                            <a href="#">
                                                                <div class="background-image-maker rounded-left h-283"></div>
                                                                <div class="holder-image">
                                                                    <img src="dist/images/img7.jpg" alt="" class="img-fluid d-none" />
                                                                </div>
                                                            </a>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-lg-5 align-self-center">
                                                        <div class="p-4 p-lg-0">
                                                            <h6 class="mb-2"><a href="listing-details.php">Land Rover Discovery XXV</a></h6>
                                                            <ul class="list-unstyled mb-2 c-line-height-2_5">
                                                                <li><h6 class="c-primary mb-0"><small class="c-light">Price</small> $41,300 </h6></li>
                                                                <li><i class="fa fa-map-marker pr-1"></i> South City, New York</li>
                                                            </ul>
                                                            <ul class="list-inline">
                                                                <li class="list-inline-item mr-3"><a href="#" class="c-light"><i class="flaticon-calendar pr-1"></i> 2015 </a></li>
                                                                <li class="list-inline-item mr-3"><a href="#" class="c-light"><i class="flaticon-clock pr-1"></i> 35,000</a></li>
                                                                <li class="list-inline-item mr-3"><a href="#" class="c-light"><i class="flaticon-fuel pr-1"></i>  Petrol </a></li>
                                                                <li class="list-inline-item"><a href="#" class="c-light"><i class="flaticon-transport-2 pr-1"></i>  Auto </a></li>
                                                            </ul>
                                                            <a href="listing-details.php" class="btn btn-outline-primary text-uppercase btn-lg c-font-weight-700" tabindex="-1">View Details</a>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-lg-3">
                                                        <div class="border border-right-0 border-top-0 border-bottom-0 c-brd-light py-4">
                                                            <table class="table mb-0 c-line-height-1 c-brd-light">
                                                                <tbody>
                                                                    <tr>
                                                                        <td class="c-dark c-font-weight-600 b-r">Body Type:</td>
                                                                        <td>SUV</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="c-dark c-font-weight-600 b-r">Brand:</td>
                                                                        <td>Land Rover</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="c-dark c-font-weight-600 b-r">Model:</td>
                                                                        <td>2015</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="c-dark c-font-weight-600 b-r">Fuel Type:</td>
                                                                        <td>Diesel</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="c-dark c-font-weight-600 b-r">Transmission:</td>
                                                                        <td>Automatic</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td class="c-dark c-font-weight-600 b-r">Color:</td>
                                                                        <td>Silver</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div> -->
                    </div>
                    <div class="row mt-4">
                        <div class="col-12 col-sm-12">
                            <ul class="pagination mb-0 text-center text-uppercase justify-content-center">
                                <li class="page-item"><a class="page-link" href="#"><i class="fa fa-angle-left pr-1"></i> Prev</a></li>
                                <li class="page-item d-none d-sm-inline-block"><a class="page-link" href="#">1</a></li>
                                <li class="page-item d-none d-sm-inline-block active"><a class="page-link" href="#">2</a></li>
                                <li class="page-item d-none d-sm-inline-block"><a class="page-link" href="#">3</a></li>
                                <li class="page-item"><a class="page-link" href="#"> Next <i class="fa fa-angle-right pl-1"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- End List Without Sidebar -->
<%- include ../sitelayouts/footer.ejs %>
<script>
    var base_url = window.location.origin;
    function removeURLParameter(parameter) {
        var url = window.location.search;
        var urlparts = url.split('?');
        if (urlparts.length >= 2) {
            var prefix = encodeURIComponent(parameter) + '=';
            var pars = urlparts[1].split(/[&;]/g);
            for (var i = pars.length; i-- > 0; ) {
                //idiom for string.startsWith
                if (pars[i].lastIndexOf(prefix, 0) !== -1) {
                    pars.splice(i, 1);
                }
            }

            url = urlparts[0] + '?' + pars.join('&');
            var new_url = "/search-cars?type=" + GetParameterValues('type') + url;
            window.history.pushState("data", "Title", url);
        } else {
            var new_url = "/search-cars?type=" + GetParameterValues('type') + url;
            window.history.pushState("data", "Title", url);
        }
    }
    function GetParameterValues(param) {
        var url = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < url.length; i++) {
            var urlparam = url[i].split('=');
            if (urlparam[0] == param) {
                return urlparam[1];
            }
        }
    }

    function get_filter_value(param) {
        var value = $('#' + param).val();
        if (!value) {
            value = GetParameterValues(param);
        }
        if (!value) {
            value = '';
        }
        return value;
    }
    function search_results() {
        var formData = {
            make: get_filter_value('make'),
            model: get_filter_value('model'),
            radius: get_filter_value('radius'),
            aggregatedTrim: get_filter_value('aggregatedTrim'),
        }
        var url = base_url + '/auto-search-results';
        $('#loading').css('display', 'block')
        $.get(url, formData, function (data) {
            $('#ProductShow').html('')
            $.each(data.cars, function (index, value) {
                var ab = '';
                $(' <ul class="list-inline">' + value.listings + '</ul>').find('li').each(function (i, elem) {
                    ab += '<li>' + $.trim($(this).text()) + '</li>';
                });
                $('#ProductShow').append('<div class="product-bar"><div class="col-md-4 h-283"><div class="position-relative">\n\
 <a href="http://sellbuymotors.co.uk/productView/' + value.product_id + '"><div class="background-image-maker rounded-left h-283" style="background-image: url(&quot;' + value.image + ';);"></div>\n\
<div class="holder-image"><img src="' + value.image + '" alt="" class="img-fluid d-none">\n\
</div></a></div></div>' +
                        '<div class="col-md-4 title-products align-self-center">' +
                        '<div class="p-4 p-lg-0">' +
                        '<h6 class="mb-2"><a href="http://sellbuymotors.co.uk/productView/' + value.product_id + '">' + value.name + '</a></h6>' +
                        ' <ul class="list-unstyled mb-2 c-line-height-2_5">' +
                        ' <li><h6 class="mb-0"><small class="c-light">Price</small> ' + value.price + ' </h6></li>' +
                        '</ul>' + value.description.substr(0, 250) +
                        '<a href="http://sellbuymotors.co.uk/productView/' + value.product_id + '" class="btn btn-outline-primary text-uppercase btn-lg c-font-weight-700" tabindex="-1">' +
                        ' View Details' +
                        ' </a>' +
                        '</div>' +
                        ' </div>' +
                        '<div class="col-md-4 listind-detail">' +
                        ' <div class="border border-right-0 border-top-0 border-bottom-0 c-brd-light py-4">' +
                        ' <ul class="list-inline"><h1>Features</h1>' + ab +
                        '</ul>' +
                        '</div>' +
                        '</div>' +
                        '</div>');

            });
            $('#foundCar').text(data.count)
            $('#radius').html('')
            $.each(data.filters.radius, function (key, value) {
                $('#radius').append('<option value="' + value.value + '">' + value.text + '</option>')
            })
            $('#make').html('')
            $.each(data.filters.make, function (key, value) {
                $('#make').append('<option value="' + value.value + '">' + value.count + '</option>')
            })
            $('#model').html('')
            $.each(data.filters.model, function (key, value) {
                $('#model').append('<option value="' + value.value + '">' + value.count + '</option>')
            })
            $('#aggregatedTrim').html('')
            $.each(data.filters.aggregatedTrim, function (key, value) {
                $('#aggregatedTrim').append('<option value="' + value.value + '">' + value.count + '</option>')
            })
            $('#loading').css('display', 'none')
            $('#radius').val(formData.radius)
            $('#make').val(formData.make.replace("%20", " "))
            $('#model').val(formData.model.replace("%20", " "))
            $('#aggregatedTrim').val(formData.aggregatedTrim.replace("%20", " "))
            console.log(formData)
            var c_url = '';
            $.each(formData, function (key, value) {
                if (value == null)
                    c_url += '&' + key + '=';
                else
                    c_url += '&' + key + '=' + value;
            });
            var new_url = "/search-cars?type=" + GetParameterValues('type') + c_url;
            window.history.pushState("data", "Title", new_url);
        }, 'json')
    }
    search_results()
    $(document).on('change', '.rounded', function () {
        search_results()
    })
    $(document).on('change', '#make', function () {
        $('#model').html('');
        $('#aggregatedTrim').html('');
        removeURLParameter('model')
        removeURLParameter('aggregatedTrim')
        search_results()
    })
    $(document).on('change', '#model', function () {
        removeURLParameter('aggregatedTrim')
        $('#aggregatedTrim').html('');
        search_results()
    })

</script>